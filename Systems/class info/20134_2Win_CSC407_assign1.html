<html><head>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">

 
  <title>CSC 407: Computer Systems II: 2014 Winter, Assignment #1</title>
 </head><body>
  <center>
  <h2>CSC 407: Computer Systems II: 2014 Winter, Assignment #1</h2>
  <p>Last Modified 2014 January 5</p>
  </center>

  <h4>Purpose:</h4>
  To go over issues related to how the <em>compiler</em> and the <em>linker</em>
  serve <strong>you,</strong> the programmer.

  <h3>Computing</h3>
  <p>
  Please <a href="">ssh</a> into ctilinux1.cstcis.cti.depaul.edu, or use your own Linux machine.
  </p>

  <ol type="1">
  <li><h4>Compiler optimization (45 Points)</h4>
    Consider the following program.
<pre>/* <strong>q1.c</strong>
 */
#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;

#define	 unsigned int		uint

#define	 LENGTH			((uint) 1024*64)

int	 initializeArray	(uint		len,
	 			 int*		intArray
	 			)
{
  uint	i;

  for  (i = 0;  i &lt; len;  i++)
    intArray[i] = (rand() % 64);
}



uint	countAdjacent	(int		index,
			 int*		intArray,
			 int		direction
			)
{
  uint	i;
  uint	sum	= 0;

  for  (i = 0;  i &lt; index;  i++)
    if  ( intArray[i] == (intArray[i+1] + direction) )
      sum++;

  return(sum);
}



uint	funkyFunction		(uint		len,
				 int*		intArray
				)
{
  uint	i;
  uint	sum	= 0;

  for  (i = 0;  i &lt; len-1;  i++)
    if  ( (i % 16) == 0x4 )
      sum += 4*countAdjacent(len-2,intArray,+1);
    else
      sum += 5*countAdjacent(len-2,intArray,-1);

  return(sum);
}


int	main	()
{
  int*		intArray	= (int*)calloc(LENGTH,sizeof(int));

  initializeArray(LENGTH,intArray);
  printf(&quot;funkyFunction() == %d\n&quot;,funkyFunction(LENGTH,intArray));
  free(intArray);
  return(EXIT_SUCCESS);
}
</pre>

    <ol type="A">
      <li>(8 Points) Compile it for profiling but with <strong>no</strong> extra optimization with:
<pre>$ <strong>gcc -o q1None -pg q1.c</strong> # Compiles q1.c to write q1None to make profile info
$ <strong>./q1None</strong>               # Runs q1None
$ <strong>gprof q1None</strong>           # Gives profile info on q1None
</pre>
          <p>
	    <strong>Be sure to scroll all the way to the top of <code>gprof</code> output!</strong><br/>
            What are the number of <em>self seconds</em> taken by:
	    <table border="1">
	      <tbody>
		<tr><td>Function</td><td>Self seconds</td></tr>
		<tr><td>initializeBigArray()</td> <td>__________</td></tr>
		<tr><td>countAdjaceent()</td> <td>__________</td></tr>
		<tr><td>funkyFunction()</td> <td>__________</td></tr>
	      </tbody>
	    </table>
	  </p>

      </li>

      <li>
	(8 Points)
	How did it do the operation <code>(i % 16) == 0x4</code>?
	<strong>Was it done as a modulus (the same as an expensive division, but returns the remainder instead of the quotient) <em>or</em> something else?
	Show the assembly language for this C code</strong>
	using gdb to dissassemble
	<code>funkyFunction()</code> of <code>q1None</code>.

	<p>
	  <strong>Hint:</strong> do:
<pre>$ <strong>gdb q1None</strong>
. . .
(gdb) <strong>disass funkyFunction</strong>
Dump of assembler code for function funkyFunction:
   . . .
</pre>
	  and then look for the code that sets up the calls to <code>countAdjacent()</code>.
	  The <code>(i % 16) == 0x4</code> test is done before either <code>countAdjacent()</code> call.
	  </p>
      </li>

      <li>(8 Points) Compile it for profiling but <strong>with</strong> optimization with:
<pre>$ <strong>gcc -o q1Compiler -O1 -pg q1.c</strong> # Compiles q1.c to write q1Compiler to make profile info
$ <strong>./q1Compiler</strong>                   # Runs q1Compiler
$ <strong>gprof q1Compiler</strong>               # Gives profile info on q1Compiler
</pre>
          <p>
          What are the number of <em>self seconds</em> taken by:
	  <table border="1">
	    <tbody>
	      <tr><td>Function</td><td>Self seconds</td></tr>
	      <tr><td>initializeBigArray()</td> <td>__________</td></tr>
	      <tr><td>countAdjacent()</td> <td>__________</td></tr>
	      <tr><td>funkyFunction()</td> <td>__________</td></tr>
	    </tbody>
	  </table>
	  </p>

      </li>

      <li>(8 Points) Use gdb to dissassemble <code>countAdjacent()</code> of both <code>q1None</code> and <code>q1Compiler</code>.
	  <p>
	  <em>Don't try to understand all the code but in general</em> how did the optimizer make <code>q1Compiler</code>'s <code>countAdjacent()</code> faster than <code>q1None</code>'s?
	    Give a specific example by comparing both assembly codes.
	  </p>

      </li>

      <li>(8 Points) One optimization the compiler may not have made would be do the two <code>countAdjacent()</code> calls once each before the loop in <code>funkyFunction()</code>, put them in variables, and then use those variables in the loop.
	  Re-write the code this way:
<pre>  . . .
  uint	i;
  uint	sum	= 0;
  uint  countUp = 4*countAdjacent(len-2,intArray,+1);
  uint  countDn = 5*countAdjacent(len-2,intArray,-1);


  for  (i = 0;  i < len-1;  i++)
    if  ( (i % 16) == 0x4 )
      sum += countUp;
    else
      sum += countDn;
</pre>

          <p>
	    Compile it for profiling again with optimization with:
</p><pre>$ <strong>gcc -o q1Programmer -O1 -pg q1.c</strong> # Compiles q1.c to write q1Programmer to make profile info
$ <strong>./q1Programmer</strong>                   # Runs q1Programmer
$ <strong>gprof q1Programmer</strong>               # Gives profile info on q1Programmer
</pre>
          </p>

          <p>
          What are the number of <em>self seconds</em> taken by:
	  <table border="1">
	    <tbody>
	      <tr><td>Function</td><td>Self seconds</td></tr>
	      <tr><td>initializeBigArray()</td> <td>__________</td></tr>
	      <tr><td>countAdjacent()</td> <td>__________</td></tr>
	      <tr><td>funkyFunction()</td> <td>__________</td></tr>
	    </tbody>
	  </table>
	  </p>
      </li>

      <li>(5 Points) Which optimizations ought to be done by the <em>compiler</em>?<br>
	  Which optimizations ought to be done by the <em>programmer</em>?
      </li>
    </ol>

   <p/>

  </li>

  <li><h4>Linker operation (55 Points total)</h4>
      The program file <code>p1.c</code> below compiles under Linux to create an object file <code>p1.o</code>.
      It is to be linked with another file <code>p2.o</code> to create a running program, <code>whole</code>.

<pre>/* <strong>p1.c</strong>
 */
#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;


//
//	Declarations go here:
//

//  PURPOSE:  To hold the length of the array pointed to by 'intArray'.
extern int	length;


//  PURPOSE:  To hold the array of integers.
extern int*	intArray;


//  PURPOSE:  To hold the maximum value that may place in array 'intArray'.
extern int	maxRandVal;


//  PURPOSE:  To:
//  	(1) have user enter 'length' (by calling 'enterValue()'),
//	(2) have user enter 'maxRandVal' (by calling 'enterValue()'), 
//	(3) define 'intArray' (say 'intArray =(int*)calloc(length,sizeof(int))')
//	(4) fill 'intArray' with random numbers between 0-'maxRandVal'
//	    (use expression '(rand() % (maxRandVal+1))')
//	No parameters.  No return value.
extern void	createArray	();


//  PURPOSE:  To print the values in 'intArray[]'.  No parameters.  No return
//	value.
extern void	printArray	();


//  PURPOSE:  To free 'intArray'.  No parameters.  No return value.
extern void	freeArray	();


//
//	Function and variables go here:
//

//  PURPOSE:  To hold the minimum value for 'length'.
int	minArrayLen	= 1;


//  PURPOSE:  To hold the maximum value for 'length'.
int	maxArrayLen	= 256;


//  PURPOSE:  To hold the maximum value for 'maxRandVal'.
int	maxMaxRandVal	= 256;


//  PURPOSE:  To hold the length of C-string 'line'.
#define	MAX_LINE	256


//  PURPOSE:  To hold the a C-string.
char	line[MAX_LINE];


//  PURPOSE:  To have the user enter the variable pointed to by 'valuePtr',
//	which must be between 'min' and 'max', and which is described by
//	'*descriptionPtr'.  No parameters.  No return value.
void	enterValue	(const char*	descriptionPtr,
			 int   		min,
			 int		max,
			 int*		valuePtr
			)
{

  do
  {
    printf(&quot;Please enter the %s (%d-%d): &quot;,descriptionPtr,min,max);
    fgets(line,MAX_LINE,stdin);
    *valuePtr = atoi(line);
  }
  while  ( (*valuePtr &lt; min) || (*valuePtr &gt; max) );

}


//  PURPOSE:  To define the array, print an array, and free the array.  No
//	Ignores parameters.  Returns 'EXIT_SUCCESS' to OS.
int	main		()
{
  createArray();
  printArray();
  freeArray();
  return(EXIT_SUCCESS);
}</pre>

    <p/>
    <h5>Sample output:</h5>
<pre>[instructor@JoesLaptopFedora16 Assign1]$ <strong>gcc -c p1.c</strong>
[instructor@JoesLaptopFedora16 Assign1]$ <strong>gcc -c p2.c</strong>
[instructor@JoesLaptopFedora16 Assign1]$ <strong>gcc -o whole p1.o p2.o</strong>
[instructor@JoesLaptopFedora16 Assign1]$ <strong>./whole</strong>
Please enter the array's length (1-256): <strong>0</strong>
Please enter the array's length (1-256): <strong>257</strong>
Please enter the array's length (1-256): <strong>16</strong>
Please enter the maximum random value (1-256): <strong>0</strong>
Please enter the maximum random value (1-256): <strong>257</strong>
Please enter the maximum random value (1-256): <strong>4</strong>
The array is:
intArray[0] = 3
intArray[1] = 1
intArray[2] = 2
intArray[3] = 0
intArray[4] = 3
intArray[5] = 0
intArray[6] = 1
intArray[7] = 2
intArray[8] = 4
intArray[9] = 1
intArray[10] = 2
intArray[11] = 2
intArray[12] = 0
intArray[13] = 4
intArray[14] = 3
intArray[15] = 1
[instructor@JoesLaptopFedora16 Assign1]$ 
</pre>
    <p/>

    <ol type="A">
    <li>(30 Points) Write a program file <code>p2.c</code> that would compile to <code>p2.o</code>, and would link with <code>p1.o</code> to create a legal running program <code>whole</code>.

      <p>
	<strong>Important:</strong> <em>Include your <code>p2.c</code> with your submission!</em>
      </p>

      <p>
	<strong>HINTS</strong>:
      </p>

      <ul>
	<li>What does <code>p1.c</code> need that it does not define?</li>
	<li>
	  What does <code>p1.c</code> define that <code>p2.c</code> would need?<br/>
	  Be sure to <code>extern</code> both such variable and function symbols.
	</li>
	<li>Create the individual object files and the complete executable with:
<pre>linux&gt; <em>gcc -c p1.c</em>             # creates <strong>p1.o</strong>
linux&gt; <em>gcc -c p2.c</em>             # creates <strong>p2.o</strong>
linux&gt; <em>gcc p1.o p2.o -o whole</em>  # creates <strong>whole</strong>
linux&gt; <em>./whole</em>                 # runs <strong>whole</strong>
</pre>
        </li>
      </ul>
      <p/>
    </li>

    <li>(5 Points) Use <code>objdump</code> (<em>not</em> gdb!) to disassemble both <code>main()</code> and <code>createArray()</code> in <code>whole</code>.
        Find the <code>call</code> to <code>createArray()</code> in <code>main()</code>.
        Show the math of how the number in that <code>call</code> instruction is used to compute the address where <code>createArray()</code> actually is.
    </li>

    <li>(5 Points) Which segment of <code>p1.o</code> has string constant
        used in <code>enterValue()</code>'s <code>printf()</code> call?<br>
        Show this with <code>objdump</code>.
    </li>

    <li>(5 Points) Can you find the memory for <code>enterValue()'s</code> variable <code>min</code> using <code>objdump</code>?<br>
        If you can, use <code>objdump</code> to show where it is.<br>
        If you can't, tell why not.

    </li>
    <li>(5 Points) Which segment of <code>p2.o</code> has the function <code>freeArray()</code>?<br>
        Show this with <code>objdump</code>.
        
    </li>

    <li>(5 Points) It is rather inelegant for both <code>p1.c</code> and
        <code>p2.c</code> to have the code:
<pre>//  PURPOSE:  To hold the length of C-string 'line'.
#define	MAX_LINE	256
</pre>

        because if we decide to make a change we have to remember to change all .c files.
        Suggest a more elegant solution, one that C encourages.
    </li>
    </ol>
    
  </body>
</html>
